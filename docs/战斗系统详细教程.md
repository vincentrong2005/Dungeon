# 欲望地牢战斗系统详细教程

> 面向对象：第一次深入接触本项目战斗系统的玩家、策划、维护者  
> 适用范围：当前仓库 `src/主界面/components/CombatView.vue` 与 `src/主界面/battle/*` 逻辑

## 1. 战斗系统是什么

战斗系统是本项目的核心“规则引擎”，用于把探索阶段的遭遇转化为可计算、可视化、可成长的卡牌对抗。

它由三层组成：

1. **战斗界面层（CombatView）**
   - 负责回合推进、UI交互、动画表现、日志显示、战斗结束回传。
2. **通用算法层（battle/algorithms.ts）**
   - 负责点数计算、拼点判定、伤害链路、受伤与复活逻辑。
3. **规则数据层（cardRegistry / enemyRegistry / relicRegistry / effects）**
   - 负责卡牌、敌人、圣遗物、状态效果的定义与触发规则。

---

## 2. 一场战斗的完整流程

每场战斗围绕“回合”循环，直到一方生命值归零。

### 2.1 回合主循环

1. **TURN_START（回合开始）**
   - 处理回合开始效果：如燃烧、中毒量判定、魔力源泉、冰霜附加等。
   - 掷骰前先处理疲劳度惩罚。
2. **掷骰**
   - 双方按各自骰子区间掷出基础骰值。
   - 再处理“蓄力/疲劳”这类对骰子的即时修正。
3. **DRAW_PHASE（抽牌阶段）**
   - 玩家抽 3 张牌（必要时洗牌）。
   - 敌方根据 AI 选择意图牌。
4. **PLAYER_INPUT（玩家输入阶段）**
   - 玩家从手牌中打出 1 张，或主动跳过回合。
5. **RESOLUTION（结算阶段）**
   - 判断是否拼点。
   - 执行拼点结果与双方卡牌效果。
   - 结算伤害、附加效果、复活、反伤等。
6. **TURN_END（回合结束）**
   - 处理回合结束效果：如中毒转中毒量、护甲减半、束缚衰减等。
   - 进入下一回合。

### 2.2 胜负判定

- 玩家 `HP <= 0`：失败。
- 敌人 `HP <= 0`：胜利。
- 胜负出现后进入结算动画，再把结果回传主界面。

---

## 3. 点数、拼点、伤害：三大核心机制

## 3.1 点数计算（FinalPoint）

基础公式（按当前实现）：

```text
FinalPoint = floor(BaseDice * Multiplier + Addition + 各类修正)
```

其中修正可来自：

- 卡牌参数（`multiplier/addition`）
- 圣遗物钩子（`modifyFinalPoint`）
- 部分特殊卡逻辑（在 CombatView 内实现）

## 3.2 拼点判定

会进入拼点的典型组合：

- 物理 vs 物理
- 魔法 vs 魔法
- 闪避 vs 物理/魔法

闪避是特例：

- 闪避方点数 **更小** 才算闪避成功。
- 一些卡牌有“无视闪避”，会跳过闪避拼点直接生效。

## 3.3 伤害链路

伤害先由卡牌 `damageLogic` 产出原始值，再过防御链。

`damageLogic` 三种模式：

1. `relative`：按最终点数倍率计算
2. `fixed`：固定值
3. `mixed`：固定底数 + 点数倍率

常见防御/修正顺序（非真实伤害）：

1. 攻击方寒冷减伤
2. 防守方非实体/虚幻之躯修正
3. 易伤增伤
4. 坚固减伤
5. 结界抵挡
6. 护甲吸收
7. 扣血并触发复活类效果

---

## 4. 回合中你可以做什么

### 4.1 出牌

玩家在 `PLAYER_INPUT` 阶段可以：

- 点击手牌打出
- 点击“跳过回合”

### 4.2 重掷骰子

当满足以下条件时可点击自己的骰子重掷：

- 当前处于 `PLAYER_INPUT`
- 未在掷骰动画/拼点动画中
- 战斗未进入结束流程
- 有可用重掷次数（通常来自圣遗物）

### 4.3 看敌方意图

- 敌方意图卡会显示在上方。
- 某些 debuff 会隐藏或扰动信息显示（例如认知干涉）。

---

## 5. 出牌失败的常见原因（必须掌握）

卡牌可能“看得见但点不动”，常见原因：

1. **眩晕**：无法行动。
2. **束缚**：禁用指定类型（默认常见为物理/闪避）。
3. **吞食**：基础骰值过低时禁用多个类型。
4. **禁言**：禁用魔法。
5. **魔力不足**：魔法牌费用不够。
6. **诅咒/不可用标签**：卡本身不可打出。

---

## 6. 状态效果速查（实战高频）

以下是最影响胜负的高频效果：

1. **结界**
   - 抵挡一次非真实伤害，触发后层数减少。
2. **护甲**
   - 吸收伤害；回合结束时通常减半。
3. **燃烧**
   - 回合开始造成生命损失。
4. **中毒**
   - 回合末转化为中毒量并衰减。
5. **中毒量**
   - 当中毒量达到或超过当前生命值时可触发致死判定。
6. **蓄力**
   - 下次掷骰加点，触发后清空。
7. **疲劳（状态）**
   - 下次掷骰减点，触发后清空。
8. **不屈 / 群集**
   - 死亡时触发复活。

---

## 7. 连击、多段、反伤等特殊结算

### 7.1 连击（combo）

- 连击牌在一轮结算后可让玩家继续输入（若手牌仍有可打牌）。
- 若连击牌带 `draw`，会额外补抽 1 张。

### 7.2 多段攻击（hitCount）

- 多段攻击逐段结算。
- 每段都可能触发附加效果、反伤与日志。

### 7.3 荆棘反伤

- 对物理直接伤害反弹 50%（非真实伤害场景）。

---

## 8. 圣遗物如何改变战斗

圣遗物通过钩子系统在多个时点介入战斗：

1. `onBattleStart`：开局触发
2. `onTurnStart` / `onTurnEnd`：回合边界触发
3. `onDeckShuffle`：洗牌触发
4. `modifyFinalPoint`：直接改写点数
5. `onDiceClick`：影响重掷行为
6. `onBeforeApplyEffect`：拦截状态施加
7. `onBeforeBurnDamage` / `onAfterBurnDamageTaken`：改写燃烧链路
8. `onAfterHitDealt` / `onAfterHitTaken`：命中后触发

可以把圣遗物理解为“战斗规则插件”。

---

## 9. 疲劳度系统（跨战斗压力机制）

疲劳度是战斗外部压力条，范围 0~300。

累积方式：

1. 进入战斗 +10
2. 每次出牌 +1

阈值效果：

1. `>= 100`：回合开始额外获得疲劳层（随机）
2. `>= 200`：额外叠加中毒（随机）
3. `>= 300`：直接判负（生命上限归零）

当前实现中，战斗结束后会重置疲劳度。

---

## 10. 战斗结果如何同步回主流程

战斗结束后，系统会回传以下关键信息：

1. 胜负结果
2. 玩家最终属性（至少包含 HP）
3. 战斗日志
4. 本场新增的负面状态标记

主界面会据此执行：

1. 胜利时加金币奖励（按楼层）
2. 失败时追加败北标记
3. 保存并继续剧情生成

---

## 11. 新玩家的实战建议

1. 先保证“能稳定出牌”，再追求高爆发。
2. 魔法牌强但吃 MP，别把自己打空蓝。
3. 学会在劣势回合主动跳过，避免硬拼。
4. 中毒量逼近当前 HP 时优先处理。
5. 护甲会衰减，不要只囤不转化优势。
6. 读日志能最快定位“为什么这回合突然暴毙”。

---

## 12. 常见误区

1. 闪避不是“点数越高越好”，而是通常要比对手更低。
2. UI 显示不总是“真实信息”，某些 debuff 会干扰显示。
3. 不是所有牌都能在当前状态打出，先看限制条件。
4. 连击牌结算节奏与普通牌不同，不要按普通回合理解。

---

## 13. 术语对照

1. **BaseDice**：基础骰值（本回合掷出值）
2. **FinalPoint**：结算点数（牌与修正后的结果）
3. **Clash**：拼点对撞
4. **True Damage**：真实伤害（绕过常规防御）
5. **MVU 同步**：战斗后把状态写回主流程变量

